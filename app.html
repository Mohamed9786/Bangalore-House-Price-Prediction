<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bangalore Home Price Predictor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { background-color: #f0f4f8; font-family: 'Arial', sans-serif; height: 100vh; overflow: hidden; }
    .split-container { display: flex; height: 100%; }
    .left-panel, .right-panel { width: 50%; padding: 30px; overflow-y: auto; }
    .left-panel { background-color: #ffffff; border-right: 2px solid #ddd; }
    .right-panel { position: relative; }
    #map { height: 100%; border-radius: 10px; }
    .card { border-radius: 1rem; animation: fadeIn 1s ease-in; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
  </style>
</head>
<body>
  <div class="split-container">
    <div class="left-panel">
      <div class="card shadow">
        <div class="card-header bg-primary text-white text-center">
          <h2>üè† Bangalore Home Price Predictor</h2>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="uiSqft" class="form-label">Total Square Feet</label>
            <input type="number" id="uiSqft" class="form-control" placeholder="Enter area in sqft">
          </div>

          <div class="mb-3">
            <label for="uiBHK" class="form-label">BHK</label>
            <select id="uiBHK" class="form-select">
              <option value="1">1 BHK</option>
              <option value="2">2 BHK</option>
              <option value="3">3 BHK</option>
              <option value="4">4 BHK</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="uiBathrooms" class="form-label">Bathrooms</label>
            <select id="uiBathrooms" class="form-select">
              <option value="1">1 Bathroom</option>
              <option value="2">2 Bathrooms</option>
              <option value="3">3 Bathrooms</option>
              <option value="4">4 Bathrooms</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="uiLocations" class="form-label">Select Location</label>
            <select id="uiLocations" class="form-select">
              <option disabled selected>Loading locations...</option>
            </select>
          </div>

          <button id="estimateButton" class="btn btn-success w-100 mt-4">Estimate Price</button>

          <div id="uiEstimatedPrice" class="alert alert-info mt-4 text-center" role="alert">
            Estimated price will appear here.
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div id="map"></div>
    </div>
  </div>

  <script>
    let map = L.map('map').setView([12.9716, 77.5946], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    let marker = L.marker([12.9716, 77.5946]).addTo(map)
                 .bindPopup("Select a location").openPopup();

    function estimatePrice() {
      let sqft = parseFloat($('#uiSqft').val());
      let bhk = parseInt($('#uiBHK').val());
      let bathrooms = parseInt($('#uiBathrooms').val());
      let location = $('#uiLocations').val();

      if (!sqft || !bhk || !bathrooms || !location) {
        alert("Please fill all fields.");
        return;
      }

      $.ajax({
        url: "http://127.0.0.1:5000/predict_home_price",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ total_sqft: sqft, bhk: bhk, bath: bathrooms, location: location }),
        success: function(data) {
          $('#uiEstimatedPrice').html(`<h4>Estimated Price: <strong>${data.estimated_price} Lakh</strong></h4>`);
        },
        error: function(err) {
          alert("Error in prediction: " + err.statusText);
        }
      });
    }

    function onPageLoad() {
      $.get("http://127.0.0.1:5000/get_location_names", function(data) {
        if (data && data.locations) {
          $('#uiLocations').empty();
          data.locations.forEach(loc => {
            const formattedLoc = toTitleCase(loc);
            $('#uiLocations').append(new Option(formattedLoc, loc));
          });
        }
      });

      $('#uiLocations').on('change', function() {
        pinLocationOnMap($(this).val());
      });
    }

    function toTitleCase(str) {
      return str.toLowerCase().split(' ').map(word => {
        if (['i', 'ii', 'iii', 'iv', 'v', 'vi', 'vii', 'viii', 'ix'].includes(word)) {
          return word.toUpperCase();
        }
        return word.charAt(0).toUpperCase() + word.slice(1);
      }).join(' ');
    }

    function pinLocationOnMap(location) {
      $.get("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(location + ', Bengaluru'), function(data) {
        if (marker) map.removeLayer(marker);
        if (data && data.length > 0) {
          let lat = parseFloat(data[0].lat);
          let lon = parseFloat(data[0].lon);
          marker = L.marker([lat, lon]).addTo(map)
                   .bindPopup(`<strong>${toTitleCase(location)}</strong>`).openPopup();
          map.setView([lat, lon], 15);
        } else {
          marker = L.marker([12.9716, 77.5946]).addTo(map)
                   .bindPopup("Location not found.").openPopup();
          map.setView([12.9716, 77.5946], 11);
        }
      });
    }

    $(document).ready(function() {
      onPageLoad();
      $('#estimateButton').on('click', estimatePrice);
    });
  </script>
</body>
</html>
